# Development Scripts

This directory contains automation scripts for Apso + BetterAuth development.

## Quick Start

### Complete Setup (New Project)

```bash
# Run the comprehensive setup script
./scripts/setup-apso-betterauth.sh
```

This will:
1. Check prerequisites (Node.js, PostgreSQL, etc.)
2. Create backend with Apso + BetterAuth
3. Create frontend with Next.js + BetterAuth
4. Configure environment variables
5. Initialize database and run migrations
6. Start both development servers
7. Verify everything works

**Estimated time:** 5 minutes

### Interactive Mode (Default)

```bash
./scripts/setup-apso-betterauth.sh
```

You'll be prompted for:
- Project name
- Database name
- Database password
- Confirmation before proceeding

### Automated Mode

```bash
./scripts/setup-apso-betterauth.sh \
  --project-name my-saas \
  --backend-port 3001 \
  --frontend-port 3003 \
  --db-name my_saas_dev \
  --db-password mypassword
```

## Available Scripts

### setup-apso-betterauth.sh

Complete automated setup for Apso + BetterAuth.

**Usage:**
```bash
./scripts/setup-apso-betterauth.sh [OPTIONS]
```

**Options:**
- `--project-name NAME` - Project name (default: interactive prompt)
- `--backend-port PORT` - Backend port (default: 3001)
- `--frontend-port PORT` - Frontend port (default: 3003)
- `--db-name NAME` - Database name (default: project_name_dev)
- `--db-user USER` - Database user (default: postgres)
- `--db-password PASS` - Database password (default: empty)
- `--db-host HOST` - Database host (default: localhost)
- `--db-port PORT` - Database port (default: 5432)
- `--skip-install` - Skip npm install steps
- `--skip-db` - Skip database initialization
- `--help` - Show help message

**Features:**
- Colored output with progress indicators
- Prerequisite validation
- Automatic rollback on failure
- Environment variable generation with secure secrets
- Database creation and migration
- Service health checks
- Comprehensive error handling

### verify-setup.sh

Verify that your Apso + BetterAuth setup is working correctly.

**Usage:**
```bash
./scripts/verify-setup.sh [OPTIONS]
```

**Options:**
- `--backend-port PORT` - Backend port (default: 3001)
- `--frontend-port PORT` - Frontend port (default: 3003)
- `--db-name NAME` - Database name (default: from .env)
- `--verbose` - Show detailed output
- `--help` - Show help message

**Checks:**
- Prerequisites (Node.js, npm, PostgreSQL)
- Directory structure
- Environment variables
- Database connection and tables
- Running services
- Code structure
- Dependencies

**Exit codes:**
- `0` - All checks passed
- `1` - Critical failures detected

### stop-servers.sh

Stop backend and frontend development servers.

**Usage:**
```bash
./scripts/stop-servers.sh
```

**What it does:**
- Reads PIDs from `dev-servers.pid`
- Gracefully stops backend process
- Gracefully stops frontend process
- Removes PID file
- Fallback: kills processes on ports 3001 and 3003

### restart-servers.sh

Restart both development servers.

**Usage:**
```bash
./scripts/restart-servers.sh
```

**What it does:**
- Stops existing servers
- Waits 2 seconds
- Starts backend server
- Starts frontend server
- Saves new PIDs

### view-logs.sh

View development server logs in real-time.

**Usage:**
```bash
./scripts/view-logs.sh [backend|frontend|both]
```

**Examples:**
```bash
# View backend logs only
./scripts/view-logs.sh backend

# View frontend logs only
./scripts/view-logs.sh frontend

# View both (default)
./scripts/view-logs.sh
./scripts/view-logs.sh both
```

**Log files:**
- Backend: `/tmp/backend-dev.log`
- Frontend: `/tmp/frontend-dev.log`

## Common Workflows

### First Time Setup

```bash
# 1. Run setup
./scripts/setup-apso-betterauth.sh

# 2. Verify everything works
./scripts/verify-setup.sh

# 3. View logs (in separate terminal)
./scripts/view-logs.sh
```

### Daily Development

```bash
# Start servers (if not running)
cd backend && npm run start:dev &
cd frontend && npm run dev &

# Or restart if already running
./scripts/restart-servers.sh

# View logs
./scripts/view-logs.sh both

# Stop when done
./scripts/stop-servers.sh
```

### Troubleshooting

```bash
# 1. Verify setup
./scripts/verify-setup.sh --verbose

# 2. Check logs
./scripts/view-logs.sh both

# 3. Restart servers
./scripts/restart-servers.sh

# 4. If still broken, re-run setup
./scripts/setup-apso-betterauth.sh
```

## Environment Variables

### Backend (.env)

Generated automatically by setup script:

```bash
# Database Configuration
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=your-password
DB_NAME=project_name_dev

# Server Configuration
PORT=3001
NODE_ENV=development
FRONTEND_URL=http://localhost:3003

# Authentication
JWT_SECRET=<auto-generated>
AUTH_SECRET=<auto-generated>

# OAuth Providers (optional)
# GOOGLE_CLIENT_ID=
# GOOGLE_CLIENT_SECRET=
# GITHUB_CLIENT_ID=
# GITHUB_CLIENT_SECRET=
```

### Frontend (.env.local)

Generated automatically by setup script:

```bash
# API Configuration
NEXT_PUBLIC_API_URL=http://localhost:3001

# Authentication
BETTER_AUTH_SECRET=<auto-generated>
BETTER_AUTH_URL=http://localhost:3003
```

## Customization

### Custom Ports

```bash
./scripts/setup-apso-betterauth.sh \
  --backend-port 4000 \
  --frontend-port 4001
```

### Custom Database

```bash
./scripts/setup-apso-betterauth.sh \
  --db-host 192.168.1.100 \
  --db-port 5433 \
  --db-user myuser \
  --db-password mypassword \
  --db-name custom_db
```

### Skip Steps

```bash
# Skip npm install (if already installed)
./scripts/setup-apso-betterauth.sh --skip-install

# Skip database setup (if already exists)
./scripts/setup-apso-betterauth.sh --skip-db

# Skip both
./scripts/setup-apso-betterauth.sh --skip-install --skip-db
```

## Error Handling

### Automatic Rollback

If setup fails, the script automatically:
- Kills any background processes
- Removes created directories
- Deletes generated files
- Shows detailed error messages

### Manual Recovery

If you need to manually clean up:

```bash
# Stop servers
./scripts/stop-servers.sh

# Remove backend/frontend (if needed)
rm -rf backend frontend

# Drop database (if needed)
psql -U postgres -c "DROP DATABASE IF EXISTS project_name_dev;"

# Re-run setup
./scripts/setup-apso-betterauth.sh
```

## Log Files

All setup and runtime logs are stored in `/tmp/`:

- `/tmp/backend-install.log` - Backend npm install output
- `/tmp/frontend-create.log` - Frontend creation output
- `/tmp/frontend-better-auth.log` - BetterAuth install output
- `/tmp/backend-build.log` - Backend build output
- `/tmp/db-drop.log` - Database drop output
- `/tmp/db-create.log` - Database creation output
- `/tmp/migration-run.log` - Migration output
- `/tmp/backend-dev.log` - Backend runtime logs
- `/tmp/frontend-dev.log` - Frontend runtime logs

## Security Notes

### Generated Secrets

The setup script generates cryptographically secure random secrets for:
- `JWT_SECRET` - Used for JWT token signing
- `AUTH_SECRET` - Used by BetterAuth for session management

These are generated using `openssl rand -base64 32` or `/dev/urandom` as fallback.

### Database Passwords

For development, you can use an empty password. For production:

```bash
# Never commit passwords to git
echo ".env" >> .gitignore
echo ".env.local" >> .gitignore

# Use strong passwords
./scripts/setup-apso-betterauth.sh --db-password "$(openssl rand -base64 32)"
```

## Prerequisites

Before running setup, ensure you have:

- **Node.js** >= 18.0.0
- **npm** >= 9.0.0
- **PostgreSQL** >= 13.0
- **Git** (optional but recommended)

Check your versions:

```bash
node --version   # Should be v18.x.x or higher
npm --version    # Should be 9.x.x or higher
psql --version   # Should be 13.x or higher
```

## Platform Support

Scripts are tested on:

- macOS (primary development platform)
- Linux (Ubuntu, Debian, CentOS)
- Windows (via WSL2)

### macOS

```bash
# Install prerequisites with Homebrew
brew install node postgresql

# Start PostgreSQL
brew services start postgresql
```

### Ubuntu/Debian

```bash
# Install prerequisites
sudo apt-get update
sudo apt-get install nodejs npm postgresql postgresql-client

# Start PostgreSQL
sudo systemctl start postgresql
```

### Windows (WSL2)

```bash
# Install prerequisites (in WSL2)
sudo apt-get update
sudo apt-get install nodejs npm postgresql postgresql-client

# Start PostgreSQL
sudo service postgresql start
```

## Troubleshooting

### Common Issues

**Issue:** "PostgreSQL connection refused"

```bash
# Check if PostgreSQL is running
pg_isready

# Start PostgreSQL
# macOS
brew services start postgresql

# Linux
sudo systemctl start postgresql
```

**Issue:** "Database already exists"

```bash
# The script will prompt you to drop and recreate
# Or manually drop:
psql -U postgres -c "DROP DATABASE project_name_dev;"
```

**Issue:** "Port already in use"

```bash
# Check what's using the port
lsof -i :3001

# Kill the process
kill -9 <PID>

# Or use different ports
./scripts/setup-apso-betterauth.sh --backend-port 4000 --frontend-port 4001
```

**Issue:** "Node version too old"

```bash
# Update Node.js
# macOS
brew upgrade node

# Linux (using nvm)
nvm install 18
nvm use 18
```

## Contributing

When adding new scripts:

1. Follow the existing naming convention
2. Add proper error handling
3. Use the color/output functions
4. Document with comments
5. Update this README
6. Make executable: `chmod +x scripts/new-script.sh`

## License

MIT
